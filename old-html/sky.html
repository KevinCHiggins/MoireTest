<!DOCTYPE HTML>
<head>
	<meta charset="utf-8">
	<title>Hard-pixel SVG</title>
	<link href="https://fonts.googleapis.com/css?family=Aleo:300&display=swap" rel="stylesheet">
	<style>body {font-family: 'Aleo', serif;} h1 {text-align: center;}h3 {text-align: center;} #circle{filter: brightness(0.5) sepia(1) hue-rotate(-70deg) saturate(5);;}</style>
</head>
<body>
	<h1>Hard-pixel SVG: Masked Moir√©</h1>
	<h3>by Kevin Higgins</h3>
	<input type="button" value="Reset" id="reset-button"></input>
	<section>
		<svg xmlns="http://www.w3.org/2000/svg" id="vector" viewBox="0 0 500 500" height="500" width="500" id="inline-svg" shape-rendering="crispEdges">
			<defs>
				<mask id="mask1">
					<rect x="40" y="40" width="320" height="320" fill="white" stroke="black" stroke-width="40" />
					<circle cx="200" cy="200" r="70" fill="black" />
				</mask>
				<linearGradient id="grad1" x1="0%" y1="0%" x2="0%" y2="100%">
					<stop offset="0%" style="stop-color:rgb(255,255,0);stop-opacity:1" />
		   			<stop offset="100%" style="stop-color:rgb(255,0,0);stop-opacity:1" />
		   		</linearGradient>
		   		<linearGradient id="grad2" x1="0%" y1="100%" x2="100%" y2="0%">
					<stop offset="0%" style="stop-color:rgb(255,255,0);stop-opacity:1" />
		   			<stop offset="100%" style="stop-color:rgb(255,0,0);stop-opacity:1" />
		   		</linearGradient>
			</defs>
		</svg>
	</section>
	<script>
		document.querySelector('#reset-button').addEventListener("click", switchEl);
		var handleSize = 10;
		var svgObject = document.getElementById('vector');
		var handles = [];
		var paths = []; //conceptually inconsistently, this will hold actual line elements (until we generalise to paths) rather than, as handles does, coords for elements
		var selectedHandle = -1;
		var selectedPath = 0; // there'll always be a path selected; start with first member of array selected
		function switchEl(e) {
			for (i = 0; i < handles.length; i++) {
				svgObject.removeChild(document.querySelector('#handle' + i));
			}
			if (selectedPath  < paths.length - 1) { selectedPath++; } else { selectedPath = 0; }
			resetHandles(paths[selectedPath]);
		}
		function manifestHandle(x, y) {
			console.log("make");
			var newHandle = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
			newHandle.setAttributeNS(null, 'x', x - handleSize / 2); //handle is around centre point
			newHandle.setAttributeNS(null, 'y', y - handleSize / 2);
			newHandle.setAttributeNS(null, 'width', handleSize);
			newHandle.setAttributeNS(null, 'height', handleSize);
			newHandle.setAttributeNS(null, 'fill', 'red');
			newHandle.setAttributeNS(null, 'class', 'draggable');
			newHandle.setAttributeNS(null, 'id', 'handle' + i);
			newHandle.addEventListener("mousedown", startDragging);
			document.addEventListener("mousemove", drag);
			newHandle.addEventListener("mouseup", endDragging);
			svgObject.appendChild(newHandle);
		}
		function getID(handle) {
			return handle.getAttributeNS(null, 'id').charAt(6);
		}
		function startDragging(e) {
			thisHandle = e.currentTarget;
			selectedHandle = getID(thisHandle);
			grabX = e.offsetX - handles[selectedHandle][0];
			grabY = e.offsetY - handles[selectedHandle][1];
			console.log('Graby' + grabX);
			console.log('Graby' + grabY);
			console.log((handles[selectedHandle][0]) + ' ' + (handles[selectedHandle][1])); 
		}
		function drag(e) {
			if (selectedHandle >= 0) { //drawing the lines is making it hard to mouseup
				newX = e.offsetX - grabX;
				newY = e.offsetY - grabY;
				handles[selectedHandle][0] = newX;
				handles[selectedHandle][1] = newY;
				console.log((handles[selectedHandle][0]) + ' ' + (handles[selectedHandle][1])); 
				handle = document.querySelector('#handle' + selectedHandle);
				handle.setAttributeNS(null, 'x', newX - handleSize / 2); //this should be a method that handles it in one place
				handle.setAttributeNS(null, 'y', newY - handleSize / 2);
				updatePath(paths[selectedPath], handles[selectedHandle][0], handles[selectedHandle][1], selectedHandle); // on the way to generalising it
				redrawHandles(); // so they'll be displayed on top - quick and dirty fix
			}
		}
		function endDragging(e) {
			selectedHandle = -1;

		}
		function redrawHandles() {
			for (i = 0; i < handles.length; i++) {
				handle = document.querySelector('#handle' + i);
				svgObject.removeChild(handle);
				svgObject.appendChild(handle); //quick fix of order of displaying
			}
		}
		function updatePath(path, handleX, handleY, handleId) {
			stroke = path.getAttributeNS(null, 'stroke');
			svgObject.removeChild(path);
			if (handleId== 0){
			
				path.setAttributeNS(null, 'x1', handleX);
				path.setAttributeNS(null, 'y1', handleY);
			}
			else {
				path.setAttributeNS(null, 'x2',handleX);

				path.setAttributeNS(null, 'y2', handleY);
			}
			path.setAttributeNS(null, 'stroke-width', 500);
			path.setAttributeNS(null, 'stroke', stroke);
			path.setAttributeNS(null, 'stroke-dasharray', '1,2,1,2,1,1,1,2');
			path.setAttributeNS(null, 'mask', 'url(#mask1');
			svgObject.appendChild(path);

		}
		function resetHandles(el) { // pass which element you want to handles to control
			console.log(document.querySelector('#handle' + selectedHandle));
			//if (document.querySelector('#handle' + selectedHandle) !== null) { document.removeChild(document.querySelector('#handle' + selectedHandle)); console.log("g"); }
			console.log("reset");
			handles = [];
			for (i = 0; i < 2; i++) {
				pair = [el.getAttributeNS(null, 'x' + (i + 1)), el.getAttributeNS(null, 'y' + (i + 1))];
				handles[i] = pair;
			}
				for (i = 0; i < handles.length; i++) {
					manifestHandle(handles[i][0], handles[i][1]);
				}
		}
		for (i = 0; i < 2; i++) {
			var barLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
			/*barLine.setAttributeNS(null, 'x1', 300);
			barLine.setAttributeNS(null, 'y1', 300);
			barLine.setAttributeNS(null, 'x2', 105 + (i * 100));

			barLine.setAttributeNS(null, 'y2', 150 + i * 100);
			barLine.setAttributeNS(null, 'stroke-width', 500);
			*/
			if (i == 1) barLine.setAttributeNS(null, 'stroke', 'turquoise');//'url(#grad2)');
			if (i == 0) barLine.setAttributeNS(null, 'stroke', 'lightblue'); //'url(#grad1)');
			barLine.setAttributeNS(null, 'stroke-dasharray', '1,2,1,2,1,1,1,2');
			paths[i] = barLine;

			svgObject.appendChild(paths[i]);
			updatePath(paths[i], 300, 300 + (i * 50), 0);
			updatePath(paths[i], 105 + (i * 100), 150 + i * 100, 1);
		}
		resetHandles(paths[selectedPath]);

	</script>
		
</body>