<!DOCTYPE HTML>
<head>
	<meta charset="utf-8">
	<title>Hard-pixel SVG</title>
	<link href="https://fonts.googleapis.com/css?family=Aleo:300&display=swap" rel="stylesheet" />
	<link rel="stylesheet" href="css/styles.css" type="text/css" />
	<style></style>
</head>
<body>
	<header>
		<h1>Hard-pixel SVG: Masked Moir√©</h1>
		<h3>by Kevin Higgins</h3>
	</header>
	<main class="main-block">
		<a id="concealed-dl-link">Download SVG</a> <!--technique from boomcreeper11 on SO-->
		<div class="panels">
			<div class="svg-panel">
				<svg xmlns="http://www.w3.org/2000/svg" id="vector" viewBox="0 0 500 500" height="500" width="500" shape-rendering="crispEdges">

					<line stroke="lightblue" stroke-dasharray="1,2,1,2,1,1,1,2" x1="300" y1="300" stroke-width="500" mask="url(#mask1" x2="105" y2="150"></line><line stroke="turquoise" stroke-dasharray="1,2,1,2,1,1,1,2" x1="300" y1="350" stroke-width="500" mask="url(#mask1" x2="205" y2="250"></line>
					<path d="M 200 300 q 50 50 100 25" stroke="blue" stroke-width="5" fill="none"/>
				</svg>
			</div>

			<div class="control-panel">
				<h4>Edit selected path</h4><label for="dash-array-field">Stroke dash array</label>
				<input type="text" value="1,1" id="dash-array-field" /><label for="stroke-width-field">Stroke width</label><input type="number" placeholder="1" max="500" min="0" value="40" id="stroke-width-field" />
				<hr />

				<input type="button" value="Next path" id="reset-button"></input>
				<input type="button" value="Download" id="dl-button"></input>
			</div>
			
		</div>
	</main>
	<script>
		document.querySelector('#reset-button').addEventListener("click", switchEl);
		document.querySelector('#dl-button').addEventListener("click", downloadSvg);
		document.querySelector('#dash-array-field').addEventListener("input", function() { changeDashArray(this.value) });
		document.querySelector('#stroke-width-field').addEventListener("change", function() { changeStrokeWidth(this.value) });

		var handleSize = 10;
		var svgObject = document.getElementById('vector');
		function downloadSvg() {
			for (i = 0; i < handles.length; i++) {
				svgObject.removeChild(document.querySelector('#handle' + i));
			}
			var svgArray = [];
			svgText = '<svg xmlns="http://www.w3.org/2000/svg" id="vector" viewBox="0 0 500 500" height="500" width="500" shape-rendering="crispEdges">';
			svgText += svgObject.innerHTML + '</svg>';
			svgArray[0] = svgText;
			var blob = new Blob(svgArray, {type: 'text/html'});
			var link = document.querySelector('#concealed-dl-link');
			link.style.display = 'inline';
			link.href = URL.createObjectURL(blob);
			link.download = new Date().toLocaleString() + '.svg';
			resetHandles(shapes[selectedShape]);
		}
		var handles = [];
		var shapes = []; //conceptually inconsistently, this will hold actual line elements (until we generalise to shapes) rather than, as handles does, coords for elements
		var selectedHandle = -1;
		var selectedShape = 0; // there'll always be a shapes selected; start with first member of array selected
		function switchEl(e) {
			for (i = 0; i < handles.length; i++) {
				svgObject.removeChild(document.querySelector('#handle' + i));
			}
			if (selectedShape  < shapes.length - 1) { selectedShape++; } else { selectedShape = 0; }
			resetHandles(shapes[selectedShape]);
			console.log("Shape no.", selectedShape);
			setControls();
		}
		function changeStrokeWidth(val) {
			shapes[selectedShape].setAttributeNS(null, 'stroke-width', val);
		}
		function changeDashArray(val) {
			shapes[selectedShape].setAttributeNS(null, 'stroke-dasharray', val);
		}
		function manifestHandle(x, y) {
			console.log("make");
			var newHandle = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
			newHandle.setAttributeNS(null, 'x', x - handleSize / 2); //handle is around centre point
			newHandle.setAttributeNS(null, 'y', y - handleSize / 2);
			newHandle.setAttributeNS(null, 'width', handleSize);
			newHandle.setAttributeNS(null, 'height', handleSize);
			newHandle.setAttributeNS(null, 'fill', 'red');
			newHandle.setAttributeNS(null, 'class', 'draggable');
			newHandle.setAttributeNS(null, 'id', 'handle' + i);
			newHandle.addEventListener("mousedown", startDragging);
			document.addEventListener("mousemove", drag);
			newHandle.addEventListener("mouseup", endDragging);
			svgObject.appendChild(newHandle);
		}
		function getID(handle) {
			return handle.getAttributeNS(null, 'id').charAt(6);
		}
		function startDragging(e) {
			thisHandle = e.currentTarget;
			selectedHandle = getID(thisHandle);
			grabX = e.offsetX - handles[selectedHandle][0];
			grabY = e.offsetY - handles[selectedHandle][1];
			console.log('Graby' + grabX);
			console.log('Graby' + grabY);
			console.log((handles[selectedHandle][0]) + ' ' + (handles[selectedHandle][1])); 
		}
		function drag(e) {
			if (selectedHandle >= 0) { //drawing the lines is making it hard to mouseup
				newX = e.offsetX - grabX;
				newY = e.offsetY - grabY;
				handles[selectedHandle][0] = newX;
				handles[selectedHandle][1] = newY;
				console.log((handles[selectedHandle][0]) + ' ' + (handles[selectedHandle][1])); 
				handle = document.querySelector('#handle' + selectedHandle);
				handle.setAttributeNS(null, 'x', newX - handleSize / 2); //this should be a method that handles it in one place
				handle.setAttributeNS(null, 'y', newY - handleSize / 2);
				updateShape(shapes[selectedShape], handles[selectedHandle][0], handles[selectedHandle][1], selectedHandle); // on the way to generalising it
				redrawHandles(); // so they'll be displayed on top - quick and dirty fix
			}
		}
		function endDragging(e) {
			selectedHandle = -1;

		}
		function redrawHandles() {
			for (i = 0; i < handles.length; i++) {
				handle = document.querySelector('#handle' + i);
				svgObject.removeChild(handle);
				svgObject.appendChild(handle); //quick fix of order of displaying
			}
		}
		function updateShape(shape, handleX, handleY, handleId) {
			stroke = shape.getAttributeNS(null, 'stroke');
			svgObject.removeChild(shape);
			if (handleId== 0){
			
				shape.setAttributeNS(null, 'x1', handleX);
				shape.setAttributeNS(null, 'y1', handleY);
			}
			else {
				shape.setAttributeNS(null, 'x2',handleX);

				shape.setAttributeNS(null, 'y2', handleY);
			}
			//shape.setAttributeNS(null, 'stroke-width', 500);
			shape.setAttributeNS(null, 'stroke', stroke);
			//shape.setAttributeNS(null, 'stroke-dasharray', '1,2,1,2,1,1,1,2');
			shape.setAttributeNS(null, 'mask', 'url(#mask1');
			svgObject.appendChild(shape);

		}
		function parseShapeData(el) {	// a basic version of what's to come - assume shapes only have an M and a q command, in that order

		}
		function resetHandles(el) { // pass which element you want to handles to control
			console.log(document.querySelector('#handle' + selectedHandle));
			//if (document.querySelector('#handle' + selectedHandle) !== null) { document.removeChild(document.querySelector('#handle' + selectedHandle)); console.log("g"); }
			console.log("reset");
			handles = [];
			for (i = 0; i < 2; i++) {
				pair = [el.getAttributeNS(null, 'x' + (i + 1)), el.getAttributeNS(null, 'y' + (i + 1))];
				handles[i] = pair;
			}
				for (i = 0; i < handles.length; i++) {
					manifestHandle(handles[i][0], handles[i][1]);
				}
		}
		function setControls() {
			console.log("Switching vals");
			document.querySelector('#dash-array-field').value = shapes[selectedShape].getAttributeNS(null, 'stroke-dasharray');
			document.querySelector('#stroke-width-field').value = shapes[selectedShape].getAttributeNS(null, 'stroke-width');
		}
		/*
		for (i = 0; i < 2; i++) {
			var barLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');

			if (i == 1) barLine.setAttributeNS(null, 'stroke', 'turquoise');//'url(#grad2)');
			if (i == 0) barLine.setAttributeNS(null, 'stroke', 'lightblue'); //'url(#grad1)');
			barLine.setAttributeNS(null, 'stroke-dasharray', '1,2,1,2,1,1,1,2');
			shapes[i] = barLine;

			svgObject.appendChild(shapes[i]);
			updateShape(shapes[i], 300, 300 + (i * 50), 0);
			updateShape(shapes[i], 105 + (i * 100), 150 + i * 100, 1);
		}
		*/
		var loadedElements = svgObject.children;
		if (loadedElements.length == 0) {
			console.log("No SVG elements loaded.");
			window.alert("No SVG elements loaded. Stopping script.")
			debugger;
		}
		var j = 0;
		for (i = 0; i < loadedElements.length; i++) {
			if (loadedElements[i].nodeName == 'rect' | loadedElements[i].nodeName == 'line' | loadedElements[i].nodeName == 'path') {
				shapes[j] = loadedElements[i];
				j++;
			}
		}
		console.log(shapes.length, 'elements loaded!');
		setControls();
		resetHandles(shapes[selectedShape]);

	</script>
		
</body>